---
// auth.astro - Endpunkt zur Verarbeitung der Login-Anfrage
import { authenticate } from '../lib/auth';

// Wenn die Seite mit POST aufgerufen wird
if (Astro.request.method === 'POST') {
    try {
        // Formular-Daten empfangen
        const formData = await Astro.request.formData();
        const email = formData.get('email');
        const password = formData.get('password');

        // Validierung: Prüfen, ob E-Mail und Passwort vorhanden sind
        if (!email) {
            return Astro.redirect('/login?error=E-Mail+ist+erforderlich');
        }

        if (!password) {
            return Astro.redirect('/login?error=Passwort+ist+erforderlich');
        }

        // Authentifizierung durchführen
        const result = await authenticate(email.toString(), password.toString());

        if (!result.success) {
            // Bei Fehlschlag zurück zur Login-Seite mit Fehlermeldung
            return Astro.redirect(`/login?error=${encodeURIComponent(result.error)}`);
        }

        // Bei Erfolg: Token als Cookie setzen und zum Dashboard weiterleiten
        Astro.cookies.set('token', result.token, {
            path: '/',
            httpOnly: true,
            secure: import.meta.env.PROD, // Nur in Produktionsumgebung auf secure setzen
            sameSite: 'strict',
            maxAge: 60 * 60 * 24 // 24 Stunden
        });

        return Astro.redirect('/dashboard');
    } catch (error) {
        console.error('Login error:', error);
        return Astro.redirect('/login?error=Ein+interner+Fehler+ist+aufgetreten');
    }
}

// Wenn die Seite mit GET aufgerufen wird, zum Login umleiten
return Astro.redirect('/login');
---