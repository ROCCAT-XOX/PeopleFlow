{{ template "head" . }}
<style>
  .chart-container {
    position: relative;
    height: 300px;
  }

  .stat-card {
    transition: transform 0.2s ease-in-out;
  }

  .stat-card:hover {
    transform: translateY(-2px);
  }

  .absence-card {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
  }

  .absence-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
  }

  .overtime-bar {
    transition: width 0.5s ease-in-out;
  }

  .adjustment-card {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
  }

  .adjustment-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
  }
</style>

<body class="h-full bg-gray-50">
<!-- Navigation einfügen -->
{{ template "navigation" . }}

<!-- Hauptinhalt -->
<main class="py-10">
  <div class="px-4 sm:px-6 lg:px-8">
    {{if eq .userRole "user"}}
    <!-- USER DASHBOARD - bleibt unverändert -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Mein Dashboard</h1>
      <p class="mt-1 text-sm text-gray-500">Persönliche Übersicht</p>
    </div>

    <!-- Persönliche Statistiken -->
    <div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-4">
      <!-- Überstunden -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Überstunden-Saldo</p>
            <p class="text-2xl font-bold {{if ge .overtimeBalance 0}}text-green-600{{else}}text-red-600{{end}}">
              {{if ge .overtimeBalance 0}}+{{end}}{{printf "%.1f" .overtimeBalance}} Std
            </p>
          </div>
          <div class="p-3 rounded-full {{if ge .overtimeBalance 0}}bg-green-100{{else}}bg-red-100{{end}}">
            <svg class="h-6 w-6 {{if ge .overtimeBalance 0}}text-green-600{{else}}text-red-600{{end}}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Urlaubstage -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Resturlaub</p>
            <p class="text-2xl font-bold text-gray-900">{{.remainingVacation}} Tage</p>
            <p class="text-xs text-gray-400">von {{.vacationDays}} Tagen</p>
          </div>
          <div class="p-3 rounded-full bg-blue-100">
            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Genommener Urlaub -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Genommener Urlaub</p>
            <p class="text-2xl font-bold text-gray-900">{{printf "%.0f" .usedVacationDays}} Tage</p>
            <p class="text-xs text-gray-400">dieses Jahr</p>
          </div>
          <div class="p-3 rounded-full bg-yellow-100">
            <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Offene Anträge -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Offene Anträge</p>
            <p class="text-2xl font-bold text-gray-900">{{.pendingAbsences}}</p>
          </div>
          <div class="p-3 rounded-full bg-purple-100">
            <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Schnellzugriff -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Schnellzugriff</h3>
        <div class="space-y-3">
          <a href="/profile" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-green-100 rounded-lg mr-3">
              <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
            <div>
              <p class="font-medium">Mein Profil</p>
              <p class="text-sm text-gray-500">Persönliche Daten verwalten</p>
            </div>
          </a>

          <a href="/absence-overview" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-blue-100 rounded-lg mr-3">
              <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <div>
              <p class="font-medium">Abwesenheit beantragen</p>
              <p class="text-sm text-gray-500">Urlaub oder Krankmeldung einreichen</p>
            </div>
          </a>

          <a href="/timetracking" class="flex items-center p-3 rounded-lg hover:bg-gray-50 transition-colors">
            <div class="p-2 bg-purple-100 rounded-lg mr-3">
              <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="font-medium">Zeiterfassung</p>
              <p class="text-sm text-gray-500">Arbeitszeiten eintragen</p>
            </div>
          </a>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Meine letzten Aktivitäten</h3>
        <div class="space-y-2 text-sm">
          <p class="text-gray-500">Noch keine Aktivitäten vorhanden</p>
        </div>
      </div>
    </div>

    {{else if eq .userRole "hr"}}
    <!-- HR DASHBOARD -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">HR Dashboard</h1>
      <p class="mt-1 text-sm text-gray-500">Personalübersicht und demografische Daten</p>
    </div>

    <!-- HR Statistiken -->
    <div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-4">
      <!-- Gesamtmitarbeiter -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Gesamtmitarbeiter</p>
            <p class="text-2xl font-bold text-gray-900">{{.totalEmployees}}</p>
          </div>
          <div class="p-3 rounded-full bg-green-100">
            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Aktive Mitarbeiter -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Aktive Mitarbeiter</p>
            <p class="text-2xl font-bold text-gray-900">{{.activeEmployees}}</p>
            <p class="text-xs text-gray-400">{{.onLeaveEmployees}} im Urlaub</p>
          </div>
          <div class="p-3 rounded-full bg-blue-100">
            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Krankmeldungen -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Krankmeldungen</p>
            <p class="text-2xl font-bold text-gray-900">{{.sickEmployees}}</p>
            <p class="text-xs text-gray-400">aktuell</p>
          </div>
          <div class="p-3 rounded-full bg-red-100">
            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Offene Anträge -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Offene Anträge</p>
            <p class="text-2xl font-bold text-gray-900">{{.pendingAbsencesCount}}</p>
          </div>
          <div class="p-3 rounded-full bg-yellow-100">
            <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Abwesenheitsanträge für HR -->
    {{if gt .pendingAbsencesCount 0}}
    <div class="bg-white rounded-lg shadow-md mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Offene Abwesenheitsanträge</h3>
        <a href="/absence-overview" class="text-sm text-green-600 hover:text-green-700">Alle anzeigen →</a>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          {{range $index, $absence := .pendingAbsences}}
          {{if lt $index 4}}
          <div onclick="window.location.href='/absence-overview'" class="absence-card border border-gray-200 rounded-lg p-4 hover:border-green-500">
            <div class="flex items-start justify-between">
              <div>
                <p class="font-medium text-gray-900">{{$absence.EmployeeName}}</p>
                <p class="text-sm text-gray-500">{{$absence.StartDate}} - {{$absence.EndDate}} ({{printf "%.0f" $absence.Days}} Tage)</p>
                <p class="text-xs text-gray-400 mt-1">{{$absence.Reason}}</p>
              </div>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{if eq $absence.Type "vacation"}}bg-blue-100 text-blue-800{{else}}bg-red-100 text-red-800{{end}}">
              {{if eq $absence.Type "vacation"}}Urlaub{{else}}Krankheit{{end}}
              </span>
            </div>
          </div>
          {{end}}
          {{end}}
        </div>
      </div>
    </div>
    {{end}}



    <!-- Ausstehende Überstunden-Genehmigungen (für alle berechtigten Rollen) -->
    {{if or (eq .userRole "admin") (eq .userRole "manager") (eq .userRole "hr")}}
    <div class="bg-white rounded-lg shadow-md mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center">
          <svg class="h-5 w-5 text-orange-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-lg font-semibold">Ausstehende Überstunden-Genehmigungen</h3>
          {{if gt .pendingOvertimeCount 0}}
          <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
        {{.pendingOvertimeCount}}
      </span>
          {{end}}
        </div>
        <a href="/overtime" class="text-sm text-green-600 hover:text-green-700 font-medium">Alle anzeigen →</a>
      </div>

      <div class="p-6">
        {{if gt .pendingOvertimeCount 0}}
        <div class="grid grid-cols-1 {{if eq .userRole "hr"}}lg:grid-cols-2{{else}}lg:grid-cols-3{{end}} gap-4">
        {{range $index, $adjustment := .pendingOvertimeAdjustments}}
        {{if lt $index 6}}
        <div onclick="window.location.href='/overtime'" class="adjustment-card border border-gray-200 rounded-lg p-4 hover:border-orange-500 hover:shadow-md transition-all duration-200 cursor-pointer">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <div class="flex items-center mb-1">
                <!-- Mitarbeiter Avatar -->
                <div class="h-8 w-8 rounded-full bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center text-green-700 text-xs font-medium mr-3">
                  {{ getInitials $adjustment.EmployeeName }}
                </div>
                <div>
                  <p class="font-medium text-gray-900 text-sm">{{$adjustment.EmployeeName}}</p>
                  <p class="text-xs text-gray-500">{{$adjustment.Department}}</p>
                </div>
              </div>
            </div>
            <div class="text-right">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
              {{if eq $adjustment.Type "Korrektur"}}bg-blue-100 text-blue-800
              {{else if eq $adjustment.Type "Bonus/Ausgleich"}}bg-green-100 text-green-800
              {{else if eq $adjustment.Type "Abzug"}}bg-red-100 text-red-800
              {{else}}bg-orange-100 text-orange-800{{end}}">
              {{$adjustment.Type}}
              </span>
            </div>
          </div>

          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Stunden:</span>
              <span class="text-sm font-semibold {{if contains $adjustment.Hours "+"}}text-green-600{{else}}text-red-600{{end}}">
              {{$adjustment.Hours}}
              </span>
            </div>

            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Beantragt von:</span>
              <span class="text-sm text-gray-900">{{$adjustment.AdjusterName}}</span>
            </div>

            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">Datum:</span>
              <span class="text-sm text-gray-500">{{$adjustment.CreatedAt}}</span>
            </div>

            {{if $adjustment.Reason}}
            <div class="mt-2 pt-2 border-t border-gray-100">
              <p class="text-xs text-gray-600 font-medium mb-1">Grund:</p>
              <p class="text-xs text-gray-800 line-clamp-2">{{$adjustment.Reason}}</p>
            </div>
            {{end}}
          </div>

          <!-- Quick Action Buttons (nur für Admin/Manager) -->
          {{if or (eq $.userRole "admin") (eq $.userRole "manager")}}
          <div class="mt-3 pt-3 border-t border-gray-100 flex space-x-2">
            <button onclick="event.stopPropagation(); approveAdjustment('{{$adjustment.ID}}', 'approve')"
                    class="flex-1 bg-green-50 hover:bg-green-100 text-green-700 text-xs font-medium py-1.5 px-3 rounded-md transition-colors">
              <svg class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              Genehmigen
            </button>
            <button onclick="event.stopPropagation(); approveAdjustment('{{$adjustment.ID}}', 'reject')"
                    class="flex-1 bg-red-50 hover:bg-red-100 text-red-700 text-xs font-medium py-1.5 px-3 rounded-md transition-colors">
              <svg class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              Ablehnen
            </button>
          </div>
          {{end}}
        </div>
        {{end}}
        {{end}}
      </div>
      {{else}}
      <!-- Keine ausstehenden Anträge -->
      <div class="text-center py-8">
        <div class="mx-auto h-12 w-12 text-gray-400 mb-4">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h3 class="text-sm font-medium text-gray-900 mb-1">Keine ausstehenden Überstunden-Genehmigungen</h3>
        <p class="text-sm text-gray-500">Alle Überstunden-Anpassungen sind bearbeitet.</p>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}

    <!-- Charts für HR -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Abteilungsverteilung -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Abteilungsverteilung</h3>
        <div class="chart-container">
          <canvas id="hrDepartmentChart"></canvas>
        </div>
      </div>

      <!-- Mitarbeiterstatus -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Mitarbeiterstatus</h3>
        <div class="chart-container">
          <canvas id="hrStatusChart"></canvas>
        </div>
      </div>

      <!-- Altersverteilung -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Altersverteilung</h3>
        <div class="chart-container">
          <canvas id="hrAgeChart"></canvas>
        </div>
      </div>

      <!-- Krankheitsverlauf -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Krankheitsverlauf (12 Monate)</h3>
        <div class="chart-container">
          <canvas id="hrSicknessChart"></canvas>
        </div>
      </div>
    </div>

    {{else}}
    <!-- ADMIN/MANAGER DASHBOARD -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
      <p class="mt-1 text-sm text-gray-500">Unternehmensübersicht</p>
    </div>

    <!-- Admin/Manager Statistiken -->
    <div class="grid grid-cols-1 gap-6 mb-6 lg:grid-cols-5">
      <!-- Mitarbeiter -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Mitarbeiter</p>
            <p class="text-2xl font-bold text-gray-900">{{.totalEmployees}}</p>
          </div>
          <div class="p-3 rounded-full bg-green-100">
            <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Personalkosten -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Personalkosten/Monat</p>
            <p class="text-2xl font-bold text-gray-900">{{.monthlyLaborCosts}} €</p>
          </div>
          <div class="p-3 rounded-full bg-blue-100">
            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Überstunden Gesamt -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Überstunden Gesamt</p>
            <p class="text-2xl font-bold {{if ge .totalOvertime 0}}text-green-600{{else}}text-red-600{{end}}">
              {{if ge .totalOvertime 0}}+{{end}}{{printf "%.0f" .totalOvertime}} Std
            </p>
          </div>
          <div class="p-3 rounded-full {{if ge .totalOvertime 0}}bg-green-100{{else}}bg-red-100{{end}}">
            <svg class="h-6 w-6 {{if ge .totalOvertime 0}}text-green-600{{else}}text-red-600{{end}}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Offene Anträge -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Offene Anträge</p>
            <p class="text-2xl font-bold text-gray-900">{{.pendingAbsencesCount}}</p>
          </div>
          <div class="p-3 rounded-full bg-yellow-100">
            <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Krankmeldungen -->
      <div class="stat-card bg-white rounded-lg shadow-md p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500">Krank heute</p>
            <p class="text-2xl font-bold text-gray-900">{{.sickToday}}</p>
            <p class="text-xs text-gray-400">+ {{.approvedAbsencesToday}} im Urlaub</p>
          </div>
          <div class="p-3 rounded-full bg-red-100">
            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Abwesenheitsanträge -->
    {{if gt .pendingAbsencesCount 0}}
    <div class="bg-white rounded-lg shadow-md mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Offene Abwesenheitsanträge</h3>
        <a href="/absence-overview" class="text-sm text-green-600 hover:text-green-700">Alle anzeigen →</a>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {{range $index, $absence := .pendingAbsences}}
          {{if lt $index 6}}
          <div onclick="window.location.href='/absence-overview'" class="absence-card border border-gray-200 rounded-lg p-4 hover:border-green-500">
            <div class="flex items-start justify-between mb-2">
              <div>
                <p class="font-medium text-gray-900">{{$absence.EmployeeName}}</p>
                <p class="text-xs text-gray-500">{{$absence.Department}}</p>
              </div>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{if eq $absence.Type "vacation"}}bg-blue-100 text-blue-800{{else}}bg-red-100 text-red-800{{end}}">
              {{if eq $absence.Type "vacation"}}Urlaub{{else}}Krankheit{{end}}
              </span>
            </div>
            <p class="text-sm text-gray-700">{{$absence.StartDate}} - {{$absence.EndDate}}</p>
            <p class="text-sm font-medium text-gray-900">{{printf "%.0f" $absence.Days}} Tage</p>
            {{if $absence.Reason}}
            <p class="text-xs text-gray-500 mt-1 truncate">{{$absence.Reason}}</p>
            {{end}}
          </div>
          {{end}}
          {{end}}
        </div>
      </div>
    </div>
    {{end}}

    <!-- Ausstehende Überstunden-Genehmigungen für Admin/Manager -->
    {{if gt .pendingOvertimeCount 0}}
    <div class="bg-white rounded-lg shadow-md mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Ausstehende Überstunden-Genehmigungen</h3>
        <a href="/overtime" class="text-sm text-green-600 hover:text-green-700">Alle anzeigen →</a>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {{range $index, $adjustment := .pendingOvertimeAdjustments}}
          {{if lt $index 6}}
          <div onclick="window.location.href='/overtime'" class="adjustment-card border border-gray-200 rounded-lg p-4 hover:border-green-500">
            <div class="flex items-start justify-between mb-2">
              <div>
                <p class="font-medium text-gray-900">{{$adjustment.EmployeeName}}</p>
                <p class="text-xs text-gray-500">{{$adjustment.Department}}</p>
              </div>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                {{$adjustment.Type}}
              </span>
            </div>
            <p class="text-sm text-gray-700">{{$adjustment.Hours}} - {{$adjustment.CreatedAt}}</p>
            <p class="text-sm font-medium text-gray-900">von {{$adjustment.AdjusterName}}</p>
            {{if $adjustment.Reason}}
            <p class="text-xs text-gray-500 mt-1 truncate">{{$adjustment.Reason}}</p>
            {{end}}
          </div>
          {{end}}
          {{end}}
        </div>
      </div>
    </div>
    {{end}}

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Personalkosten Verlauf -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Personalkosten Verlauf</h3>
        <div class="chart-container">
          <canvas id="adminLaborCostsChart"></canvas>
        </div>
      </div>

      <!-- Überstunden Verlauf -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Überstunden Verlauf</h3>
        <div class="chart-container">
          <canvas id="adminOvertimeChart"></canvas>
        </div>
      </div>

      <!-- Krankheitsverlauf -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Krankheitsverlauf (12 Monate)</h3>
        <div class="chart-container">
          <canvas id="adminSicknessChart"></canvas>
        </div>
      </div>

      <!-- Abteilungsverteilung -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">Abteilungsverteilung</h3>
        <div class="chart-container">
          <canvas id="adminDepartmentChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Überstunden Mitarbeiter -->
    {{if gt (len .overtimeEmployees) 0}}
    <div class="bg-white rounded-lg shadow-md">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold">Mitarbeiter mit höchsten Überstunden</h3>
      </div>
      <div class="p-6">
        <div class="space-y-3">
          {{range .overtimeEmployees}}
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <p class="font-medium text-gray-900">{{.Name}}</p>
            </div>
            <div class="flex items-center">
              <div class="w-32 bg-gray-200 rounded-full h-2 mr-3">
                <div class="overtime-bar h-2 rounded-full {{if eq .Status "high"}}bg-red-500{{else if eq .Status "positive"}}bg-yellow-500{{else if eq .Status "negative"}}bg-blue-500{{else}}bg-red-700{{end}}"
                style="width: {{if gt .Balance 0}}{{if gt .Balance 100}}100{{else}}{{.Balance}}{{end}}{{else}}{{if lt .Balance -100}}100{{else}}{{multiply .Balance -1}}{{end}}{{end}}%">
              </div>
            </div>
            <span class="text-sm font-medium {{if ge .Balance 0}}text-green-600{{else}}text-red-600{{end}}">
                {{if ge .Balance 0}}+{{end}}{{printf "%.1f" .Balance}} Std
              </span>
          </div>
        </div>
        {{end}}
      </div>
    </div>
  </div>
  {{end}}
  {{end}}

  <!-- Letzte Aktivitäten (für alle außer User) -->
  {{if ne .userRole "user"}}
  <div class="mt-6 bg-white rounded-lg shadow-md">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold">Letzte Aktivitäten</h3>
    </div>
    <div class="p-6">
      <div class="flow-root">
        <ul class="-mb-8">
          {{range .recentActivities}}
          <li>
            <div class="relative pb-8">
              {{if not .IsLast}}
              <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
              {{end}}
              <div class="relative flex space-x-3">
                <div>
                    <span class="h-8 w-8 rounded-full {{.IconBgClass}} flex items-center justify-center ring-8 ring-white">
                      {{.IconSVG | safeHTML}}
                    </span>
                </div>
                <div class="min-w-0 flex-1">
                  <div>
                    <div class="text-sm text-gray-500">
                      {{.Message | safeHTML}}
                    </div>
                    <p class="mt-0.5 text-sm text-gray-500">{{.Time}}</p>
                  </div>
                </div>
              </div>
            </div>
          </li>
          {{else}}
          <li class="text-center text-gray-500 py-2">
            Keine Aktivitäten gefunden
          </li>
          {{end}}
        </ul>
      </div>
    </div>
  </div>
  {{end}}
  </div>
</main>

<!-- Footer -->
{{ template "footer" . }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Einheitliche Farbpalette definieren (NUR GRÜNTÖNE)
    const globalChartColors = {
      darkestGreen: '#05402D',  // Sehr dunkles Grün
      darkGreen: '#15803D',     // Dunkelgrün
      mediumGreen: '#22C55E',   // Mittleres Grün
      lightGreen: '#86EFAC',    // Helles Grün
      limeGreen: '#C3E657',     // Gelbgrün / Limettengrün (als hellste Variante)
      // Hilfs-Array für zyklische Farbverwendung
      paletteCycle: ['#05402D', '#15803D', '#22C55E', '#86EFAC', '#C3E657']
    };

    // Helper Funktion für Währungsformatierung
    function formatCurrency(value) {
      return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
    }

    // Validierungsfunktion für Chart-Daten
    function isValidChartData(labels, data) {
      return labels && data &&
              Array.isArray(labels) && Array.isArray(data) &&
              labels.length > 0 && data.length > 0 &&
              labels.length === data.length;
    }

    // --- BEGINN: Nur für Admin/Manager Rollen (nicht HR) ---
    {{if and (ne .userRole "user") (ne .userRole "hr")}}

    // Personalkosten-Diagramm
    const adminLaborCtx = document.getElementById('adminLaborCostsChart');
    if (adminLaborCtx) {
      const monthLabels = {{.monthLabels}} || ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      const costsData = {{.monthlyCostsData}} || [];

      if (costsData.length > 0) {
        new Chart(adminLaborCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'Personalkosten (€)',
              data: costsData,
              borderColor: globalChartColors.darkGreen,
              backgroundColor: `${globalChartColors.darkGreen}33`,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'Personalkosten: ' + formatCurrency(context.parsed.y);
                  }
                }
              },
              legend: { position: 'top' }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return formatCurrency(value);
                  }
                }
              }
            }
          }
        });
      }
    }

    // Überstunden Verlauf
    const adminOvertimeCtx = document.getElementById('adminOvertimeChart');
    if (adminOvertimeCtx) {
      const monthLabels = {{.monthLabels}} || ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      const overtimeData = {{.overtimeTrend}} || [];

      if (overtimeData.length > 0) {
        new Chart(adminOvertimeCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'Überstunden Gesamt',
              data: overtimeData,
              borderColor: globalChartColors.mediumGreen,
              backgroundColor: `${globalChartColors.mediumGreen}33`,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + ' Std';
                  }
                }
              }
            },
            plugins: { legend: { display: true, position: 'top' } }
          }
        });
      }
    }

    // Krankheitsverlauf (Admin/Manager)
    const adminSickCtx = document.getElementById('adminSicknessChart');
    if (adminSickCtx) {
      const monthLabels = {{.monthLabels}} || ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      const sicknessData = {{.sicknessTrend}} || [];

      if (sicknessData.length > 0) {
        new Chart(adminSickCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'Krankmeldungen',
              data: sicknessData,
              backgroundColor: globalChartColors.darkGreen,
              borderColor: globalChartColors.darkGreen,
              borderWidth: 1,
              borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
              borderSkipped: 'bottom'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    // Abteilungsverteilung (Admin/Manager - KORRIGIERT)
    const adminDeptCtx = document.getElementById('adminDepartmentChart');
    if (adminDeptCtx) {
      const deptLabels = {{.departmentLabels}} || [];
      const deptData = {{.departmentData}} || [];

      console.log('Admin Department Chart - Labels:', deptLabels, 'Data:', deptData); // Debug

      if (isValidChartData(deptLabels, deptData)) {
        const chartColors = deptLabels.map((_, index) => globalChartColors.paletteCycle[index % globalChartColors.paletteCycle.length]);

        new Chart(adminDeptCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: deptLabels,
            datasets: [{
              data: deptData,
              backgroundColor: chartColors,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed !== null) {
                      label += context.parsed;
                      label += ' Mitarbeiter';
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      } else {
        // Fallback wenn keine Daten vorhanden
        const ctx = adminDeptCtx.getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#9CA3AF';
        ctx.textAlign = 'center';
        ctx.fillText('Keine Abteilungsdaten verfügbar', adminDeptCtx.width / 2, adminDeptCtx.height / 2);
      }
    }

    {{end}}
    // --- ENDE: Nur für Admin/Manager Rollen ---

    // --- BEGINN: Nur für HR Rolle ---
    {{if eq .userRole "hr"}}

    // Abteilungsverteilung-Diagramm (HR - KORRIGIERT)
    const hrDeptCtx = document.getElementById('hrDepartmentChart');
    if (hrDeptCtx) {
      const deptLabels = {{.departmentLabels}} || [];
      const deptData = {{.departmentData}} || [];

      console.log('HR Department Chart - Labels:', deptLabels, 'Data:', deptData); // Debug

      if (isValidChartData(deptLabels, deptData)) {
        const chartColors = deptLabels.map((_, index) => globalChartColors.paletteCycle[index % globalChartColors.paletteCycle.length]);

        new Chart(hrDeptCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: deptLabels,
            datasets: [{
              data: deptData,
              backgroundColor: chartColors,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed !== null) {
                      label += context.parsed;
                      label += ' Mitarbeiter';
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      } else {
        // Fallback wenn keine Daten vorhanden
        const ctx = hrDeptCtx.getContext('2d');
        ctx.font = '16px Arial';
        ctx.fillStyle = '#9CA3AF';
        ctx.textAlign = 'center';
        ctx.fillText('Keine Abteilungsdaten verfügbar', hrDeptCtx.width / 2, hrDeptCtx.height / 2);
      }
    }

    // Status-Verteilung-Diagramm (HR)
    const hrStatusCtx = document.getElementById('hrStatusChart');
    if (hrStatusCtx) {
      const statusLabels = {{.statusLabels}} || [];
      const statusData = {{.statusData}} || [];

      if (isValidChartData(statusLabels, statusData)) {
        const statusColors = [
          globalChartColors.mediumGreen,
          globalChartColors.lightGreen,
          globalChartColors.darkGreen,
          globalChartColors.limeGreen
        ].slice(0, statusLabels.length);

        new Chart(hrStatusCtx.getContext('2d'), {
          type: 'pie',
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusData,
              backgroundColor: statusColors,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed !== null) {
                      label += context.parsed;
                      label += ' Mitarbeiter';
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      }
    }

    // Altersverteilung-Diagramm (HR)
    const hrAgeCtx = document.getElementById('hrAgeChart');
    if (hrAgeCtx) {
      const ageLabels = {{.ageLabels}} || [];
      const ageData = {{.ageData}} || [];

      if (isValidChartData(ageLabels, ageData)) {
        new Chart(hrAgeCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ageLabels,
            datasets: [{
              label: 'Anzahl Mitarbeiter',
              data: ageData,
              backgroundColor: globalChartColors.mediumGreen,
              borderColor: globalChartColors.mediumGreen,
              borderWidth: 1,
              borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
              borderSkipped: 'bottom'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    // Krankheitsverlauf (HR)
    const hrSicknessCtx = document.getElementById('hrSicknessChart');
    if (hrSicknessCtx) {
      const monthLabels = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      const sicknessData = {{.sicknessByMonthData}} || [];

      if (sicknessData.length > 0) {
        new Chart(hrSicknessCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: [{
              label: 'Krankheitstage',
              data: sicknessData,
              borderColor: globalChartColors.darkGreen,
              backgroundColor: `${globalChartColors.darkGreen}33`,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  precision: 0,
                  callback: function(value) {
                    return value + ' Tage';
                  }
                }
              }
            }
          }
        });
      }
    }

    {{end}}
    // --- ENDE: Nur für HR Rolle ---

  });
  // Quick Approval Function für Überstunden-Anpassungen
  function approveAdjustment(adjustmentId, action) {
    const actionText = action === 'approve' ? 'genehmigen' : 'ablehnen';

    if (!confirm(`Möchten Sie diese Überstunden-Anpassung wirklich ${actionText}?`)) {
      return;
    }

    const formData = new FormData();
    formData.append('action', action);

    fetch(`/api/overtime/adjustments/${adjustmentId}/approve`, {
      method: 'POST',
      body: formData
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Success notification
                showNotification(data.message, 'success');
                // Reload page after short delay
                setTimeout(() => {
                  window.location.reload();
                }, 1500);
              } else {
                showNotification(data.error || 'Fehler beim Verarbeiten der Anfrage', 'error');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showNotification('Ein Fehler ist aufgetreten', 'error');
            });
  }

  // Simple notification function
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
            type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                            'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
    <div class="flex items-center">
      <span class="flex-1">${message}</span>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
</script>
</body>
</html>